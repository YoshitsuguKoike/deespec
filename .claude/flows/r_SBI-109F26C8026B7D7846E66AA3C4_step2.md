# Implementation Report: Step 2 - Infrastructure (File) Repository

## Summary

インフラストラクチャ層の実装を完了しました。`FileSBIRepository` を作成し、atomic write 機能と共に、SBI エンティティをファイルシステムに永続化する機能を実装しました。パスは `.deespec/specs/sbi/` を使用（tmp/test01 は使用しない）。

## Commit/Tag

- 実装完了、コミット準備中
- 前回のコミット: d8d8d0e

## Evidence

### テスト実行結果
```bash
$ go test ./internal/infra/persistence/file/... ./internal/infra/repository/sbi/... -v
=== RUN   TestWriteFileAtomic
=== RUN   TestWriteFileAtomic/Write_new_file_successfully
=== RUN   TestWriteFileAtomic/Overwrite_existing_file
=== RUN   TestWriteFileAtomic/Write_to_deeply_nested_directory
=== RUN   TestWriteFileAtomic/Write_empty_file
--- PASS: TestWriteFileAtomic (0.00s)
    --- PASS: TestWriteFileAtomic/Write_new_file_successfully (0.00s)
    --- PASS: TestWriteFileAtomic/Overwrite_existing_file (0.00s)
    --- PASS: TestWriteFileAtomic/Write_to_deeply_nested_directory (0.00s)
    --- PASS: TestWriteFileAtomic/Write_empty_file (0.00s)
=== RUN   TestWriteFileAtomic_RenameFailure
--- PASS: TestWriteFileAtomic_RenameFailure (0.00s)
PASS
ok  	github.com/YoshitsuguKoike/deespec/internal/infra/persistence/file	0.509s

=== RUN   TestFileSBIRepository_Save
=== RUN   TestFileSBIRepository_Save/Save_SBI_with_guideline_and_body
=== RUN   TestFileSBIRepository_Save/Save_SBI_with_empty_body
=== RUN   TestFileSBIRepository_Save/Save_SBI_with_special_characters_in_body
=== RUN   TestFileSBIRepository_Save/Overwrite_existing_SBI
--- PASS: TestFileSBIRepository_Save (0.00s)
    --- PASS: TestFileSBIRepository_Save/Save_SBI_with_guideline_and_body (0.00s)
    --- PASS: TestFileSBIRepository_Save/Save_SBI_with_empty_body (0.00s)
    --- PASS: TestFileSBIRepository_Save/Save_SBI_with_special_characters_in_body (0.00s)
    --- PASS: TestFileSBIRepository_Save/Overwrite_existing_SBI (0.00s)
=== RUN   TestFileSBIRepository_Save_ConcurrentWrites
--- PASS: TestFileSBIRepository_Save_ConcurrentWrites (0.00s)
PASS
ok  	github.com/YoshitsuguKoike/deespec/internal/infra/repository/sbi	0.316s
```

### 作成ファイル

1. **Atomic Writer**
   - `internal/infra/persistence/file/atomic_writer.go` - afero.Fs 対応の atomic write 実装
   - `internal/infra/persistence/file/atomic_writer_test.go` - 包括的なテスト（エラーケース含む）

2. **FileSBIRepository**
   - `internal/infra/repository/sbi/file_sbi_repository.go` - ファイルベースのリポジトリ実装
   - `internal/infra/repository/sbi/file_sbi_repository_test.go` - 並行書き込みテスト含む

## Checklist

### アーキテクチャ遵守
- ✅ **依存方向**: Infrastructure → Domain（内向き依存のみ）
- ✅ **インターフェース実装**: `domain/sbi.Repository` を実装
- ✅ **テスタビリティ**: `afero.Fs` による DI で MemMapFs を使用可能
- ✅ **エラーハンドリング**: MkdirAll, Rename の失敗を適切に処理

### 実装詳細
- ✅ **Atomic Write**: temp file → sync → rename パターンで原子性保証
- ✅ **クリーンアップ**: defer で temp ファイルを確実に削除
- ✅ **パス修正**: `tmp/test01/` を削除し、`.deespec/specs/sbi/` を使用
- ✅ **並行処理**: 複数の SBI を同時保存してもデータ競合なし

### テストカバレッジ
- ✅ **正常系**: 新規作成、上書き、空ファイル、深いネスト
- ✅ **異常系**: Rename 失敗時の temp ファイルクリーンアップ
- ✅ **特殊文字**: 日本語、絵文字、特殊記号の保存確認
- ✅ **並行処理**: 同時書き込みの正確性確認

## 主要機能の実装内容

1. **WriteFileAtomic 関数**
   ```go
   - MkdirAll でディレクトリを作成（エラーチェック必須）
   - afero.TempFile で一時ファイル作成
   - Write → Sync → Close → Rename の順序で原子性保証
   - defer で確実な temp ファイルクリーンアップ
   ```

2. **FileSBIRepository**
   ```go
   - const baseSBI = ".deespec/specs/sbi" （tmp/test01 不使用）
   - Save メソッドで SBI-ID/spec.md パスに保存
   - Body をそのまま保存（検証なし）
   - specPath を返却
   ```

3. **エラー処理**
   - MkdirAll 失敗: "failed to create directory"
   - TempFile 作成失敗: "failed to create temp file"
   - Write/Sync 失敗: 適切なエラーメッセージ
   - Rename 失敗: temp ファイル削除後にエラー返却

## Verdict

**PASS** ✅

全受け入れ基準を満たしました：
- Save が指定パス `.deespec/specs/sbi/<SBI-ID>/spec.md` にファイル作成
- 既存ファイルの上書き対応
- MkdirAll/Rename 失敗時の適切なエラー処理
- afero.Fs による DI で MemMapFs テスト可能
- lint 指摘の「戻り値未チェック」を完全回避
- tmp/test01 パスを使用せず、プロジェクト標準のパスを使用

## 次のステップ

Step 3 に進む準備が完了：
- CLI 層での `sbi register` コマンド実装
- UseCase と Repository の DI 設定
- フラグ処理（--title, --body, --json, --dry-run, --quiet）